# KiCadをGitで管理する運用
このドキュメントは、KiCadプロジェクトをGit/GitHubで安全に管理・レビューするための運用ルールを1箇所に集約したものです。  
**目的は「差分が追える」「衝突を避ける」「別PCでも再現できる」状態を維持すること**です。

---

## 1. リポジトリ構成（配置の原則）
**原則：KiCadプロジェクトは `hw/` 配下に置く。規約は `docs/` に集約する。**

推奨構成（例）：

hw/
<proj>.kicad_pro
step00_top.kicad_sch
step01_power.kicad_sch
step02_io_.kicad_sch
step03_.kicad_sch
(必要になったら) <proj>.kicad_pcb
(必要になったら) sym-lib-table
(必要になったら) fp-lib-table
lib/ # 外部ライブラリは必要時のみ（追加は別Issue）
docs/
kicad_git_workflow.md # このファイル（運用の単一の真実）
out/ # 生成物（原則git管理しない）


注意：`out/` は生成物置き場。普段はGitに入れない（リリース時だけ例外ルールあり）。

---

## 2. Gitで追跡するもの / ignoreするもの
KiCadはGUI編集だが、主要成果物はテキストファイルでありGit管理が可能。  
ただし個人環境ファイルや自動生成・バックアップ類は差分ノイズになるため除外する。

### 2.1 追跡（commit）対象（基本）
- `hw/*.kicad_pro`（プロジェクト設定。共有に有用なため原則追跡）
- `hw/*.kicad_sch`（回路図。Step分割前提）
- `hw/*.kicad_pcb`（基板。導入後は追跡）
- `hw/sym-lib-table` / `hw/fp-lib-table`（ライブラリ参照固定に有用。必要になったら追跡）
- `docs/` 配下（規約、設計ノート、意思決定ログ）

### 2.2 除外（ignore）対象（必須）
- `*.kicad_prl`（ユーザーごとの状態。必ず除外）
- `*-backups/`（バックアップフォルダ）
- `_autosave-*`（自動保存）
- `*.lck`（ロックファイル）
- `out/`（生成物置き場）

---

## 3. 回路図の分割方針（Step運用）と同時編集ルール
### 3.1 分割方針（Step01〜）
原則：回路図はStep単位のファイルに分割し、変更範囲を小さくする。

- `step00_top.kicad_sch`：最上位（俯瞰と階層シートの接続点）
- `step01_power.kicad_sch`：電源（W3でこのファイルを作る方針）
- `step02_*`：I/OやTOSLINK周辺
- `step03_*`：MCU周り
- 以降、必要に応じて `stepNN_*` を追加

命名規則：
- `stepNN_<short>.kicad_sch`（NN=01,02... / shortは小文字スネーク）
- 一度決めたファイル名は原則変更しない（差分追跡コストを上げるため）

### 3.2 同時編集しないルール（コンフリクト回避の最重要）
- 同じ `.kicad_sch` を複数ブランチで同時に編集しない
- 特に `.kicad_pcb` は衝突が解消しづらいため、次を原則とする：
  - 基板ファイルは担当者固定、または順番制（同時編集禁止）

### 3.3 Step00への統合ルール（参照の追加）
- Step01〜を作っただけではStep00に自動反映されないため、**統合は `step00_top.kicad_sch` に階層シート参照を追加して行う**
- `step00_top.kicad_sch` は統合点なので、**同時編集禁止**（衝突回避）

**推奨運用（統合PR方式）**
- 各Step作成PR（例：`step01_power.kicad_sch` 追加/更新）では **`step00_top.kicad_sch` を触らない**
- Stepが揃ったタイミングで、最後に **「統合PR」** を作り、`step00_top.kicad_sch` に **参照（階層シート）をまとめて追加**する

注意：
- ここでの「統合」は **KiCadでの参照追加**であり、**KiCad上でファイル同士を“マージ”する操作はしない**

---

## 4. ライブラリ方針（標準優先 / 外部追加は最小）
### 4.1 基本方針
- KiCad標準ライブラリを優先
- 外部ライブラリ追加は最小限にする（差分が追いにくくなるため）

### 4.2 外部ライブラリを追加する場合（必須ルール）
- 必ずIssueを分けて実施する（このIssueではやらない）
- 追加する場合はプロジェクト内に同梱し、環境依存を避ける（例：`hw/lib/`）
- 追加時に必ず記録する（PR本文またはdocsの追記）
  - 追加理由
  - 出典（URL）
  - バージョン/コミットSHAなど識別子

---

## 5. PR運用（1PR=1Step）とレビュー証跡
### 5.1 1PR=1Step の意味
- 1つのPRでは基本1つのStepファイル（例：step01_power）だけを変更する
- PRが承認されたらGitHub上でマージして積み上げる
  - KiCad上で“マージ”操作はしない
- まとめて最後に統合する運用ではなく、順次マージで前進する

### 5.2 PRに必ず添付する“証跡”（Evidence）
GUI編集のため、差分だけだとレビューが難しい。  
そのため、PRには最低限の証跡を添付してレビュー可能性を上げる。

必須（推奨）：
- 変更したStepの回路図PDF（またはスクショ）
- ERC結果（PASS/FAILが分かるスクショ/ログ）
- What（何を変更したか）/ Why（なぜ必要か）を短文で

基板がある場合（推奨）：
- DRC結果（PASS/FAILが分かるスクショ/ログ）
- 基板レンダ画像（表/裏）

---

## 6. コンフリクト（衝突）時の原則対応
原則：無理にテキストマージで解決しない。KiCadで開いて直して解決する。

- Gitでコンフリクトが出たら、まず「同時編集が起きた」ことを確認し、再発防止（担当/順番）を調整
- 解決手順（原則）
  1. 片方の変更をベースにする（どちらを採用するか決める）
  2. KiCadでファイルを開き、必要な変更を反映
  3. ERC/DRC（該当する場合）を再確認
  4. コミットして解決

---

## 7. 製造リリースの例外ルール（Gerber等の扱い）
普段は `out/` をGit管理しないが、製造に出した瞬間の成果物は再現可能な形で固定したい。

以下のいずれかを採用（プロジェクトで統一すること）：
- GitHub Releaseに、Gerber/Drill/BOM等を添付（推奨）
- タグを打ち、リリース成果物をArtifactsとして保存（推奨）
- 例外的に `release/<date>_revX/` のようなフォルダにコミット（必要時のみ）

どれを採用するかは別Issueで決めても良い（本MDでは方針のみ提示）。

---

## 8. 最小チェックリスト（運用の守り）
- [ ] KiCadプロジェクトは `hw/` 配下にある
- [ ] `*.kicad_prl` / `*-backups/` / `_autosave-*` / `out/` はGitに入れない
- [ ] 回路図は `stepNN_*` で分割し、同一ファイルの同時編集をしない
- [ ] PRは基本 1PR=1Step で小さく積み上げる
- [ ] PRに回路図PDF（またはスクショ）とERC/DRC結果を添付する
- [ ] 外部ライブラリ追加は必ずIssueを分け、理由/出典/版を残す
- [ ] コンフリクトはKiCadで開いて直し、ERC/DRCで再確認して解決する
