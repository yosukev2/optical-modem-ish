# Bring-up Procedure

## 目的
最低構成で「電気→光→電気」が成立した証拠（波形/写真/条件）と、初見でも30分で再現できる手順を残す（W3以降の設計判断を安定させる）。

---

## 0. 事前準備（共通）
### 0.1 必要機材
- マルチメータ（必須）
- ロジアナ（推奨。PulseView / Saleae Logic 等）
- PC（Thonny）

### 0.2 事前確認
- 部品の向き（Tx/Rx、TOSLINKの向き、ファイバの向き）
- ジャンパ線の刺さり（ブレッドボードが原因で接触不良が起きやすい）
- GND共有が取れていること（最優先）

---

## 1. 配線（最低構成）
### 1.1 Pico ↔ Tx/Rx（必須）
- 電源：Pico 3V3(OUT) → Tx VCC / Rx VCC（3.3Vレール扱い）
- GND：Pico GND → Tx GND / Rx GND（共通GND）
- 送信：Pico GP2 → Tx Vin
- 受信：Rx Vout → Pico GP3

補足
- プルダウン抵抗（例：220kΩ）は今回の構成では不要だった。入れるとGP3が常時0になり受信できない場合がある。

### 1.2 記録（必須）
- Photo: wiring_overview.jpg
- メモ：
  - ファイバ長：1 m
  - プル抵抗：なし（今回）
  - 電源：Pico 3V3(OUT)
  - 測定点：GP2 / GP3 / 3.3V
![wiring_overview.jpg](./img/bringup/wiring_overview.png)
---

## 2. Phase 1: Power（電源）
### 2.1 通電前チェック（PCB本線）
- [ ] 目視でショート/ブリッジがない（J1/F1/U1 周辺を優先）
- [ ] TP1/TP2/TP3/TP4 の位置を確認し、測定点を取り違えない
- [ ] VBUS_IN - GND、+3V3 - GND の短絡疑いがないことを確認する

### 2.2 適用範囲（PCB本線）
- 本線の電源判定は `2.3 PCB（USB→LDO→+3V3）電源Bring-up` を使う
- Pico 3V3 給電のブレッドボード手順は本線から分離し、`付録A` に記載する

### 2.3 PCB（USB→LDO→+3V3）電源Bring-up（テスターのみ）
事前チェック（通電前）
- 短絡確認: +3V3-GND（必要なら VBUS_IN-GND も）で短絡疑いがないことを確認する
- 極性確認: 部品向き（電解/ダイオード/TVS/LDO向き）を確認する
- 目視確認: はんだブリッジ、未はんだ、浮き部品がないことを確認する

電源投入条件（デフォルト）
- 給電元は PC 直結 USB（ハブ無し）を標準とする
- ケーブル条件は固定しない（種別 A-C/A-A、長さ目測、識別メモを記録に必須で残す）
- 外部負荷条件は 2 段階で判定する
  - (A) 基板単体
  - (B) Pico + Tx/Rx 接続後
- 室温 20-30℃ を前提とし、範囲外なら記録に残す

測定条件
- DMM は DC 電圧、オートレンジで可
- 計測器例: AstroAI DM6000AR（6000 count）または同等以上
- 仕様値（自動レンジ DCV 6V）: 分解能 1mV、精度 ±(0.8% + 3dgt)
- 精度の前提条件: メーカー仕様の基準温度（例: 23℃±5℃）から外れる場合は誤差増加を見込む
- 3.3V測定時の誤差目安: ±(3.3*0.008 + 0.003) ≒ ±0.029V（約±0.03V）
- 上記の計測誤差は PASS-B の+3V3レンジ確定時に反映する
- 黒リードを TP2（TP_GND）に当て続ける（基準点）
- 赤リードで各 TP を測る

測定手順（時系列）
1. 基板単体（A）で通電し、T+0-2 秒で TP1/TP4 を測る（致命的短絡・誤配線の早期検知）
2. 基板単体（A）で T+10 秒に TP1/TP4/TP3 を測る（初期過渡を避けた定常値を記録）
3. 任意で T+60 秒に TP1/TP4/TP3 を再測定する（軽い安定性/温度ドリフト確認）
4. Pico + Tx/Rx 接続後（B）に同手順を実施し、起動 10 秒後の TP1/TP4/TP3 を記録する（起動直後の過渡回避）
5. 任意で起動 60 秒後も再測定する（負荷時のドリフト確認）

| TP名 | 正規ネット名 | 測定場所の特定（TP or 部品参照名） | 期待値レンジ | 判定基準 |
| --- | --- | --- | --- | --- |
| TP2（TP_GND） | GND | TP2（なければ GND テストパッド） | 0 V | 0 V から大きく外れる場合は GND 参照不良として FAIL |
| TP1（TP_VBUS） | VBUS_IN | TP1（なければ J1 の VBUS 側） | PASS-A/PASS-B: 4.75-5.25 V | 範囲内なら OK（USB 5V 入力として妥当） |
| TP4（TP_VBUS_PRO） | VBUS_PRO | TP4（なければ F1 二次側または U1 IN ノード） | PASS-A/PASS-B: 4.75-5.25 V | 範囲内なら OK（保護後 5V として妥当） |
| TP3（TP_3V3） | +3V3 | TP3（なければ U1 OUT / C_OUT1 と同ノード） | PASS-A（暫定）: 3.0-3.6 V / PASS-B: TODO（未確定） | 暫定危険域は下記「TP3危険域判定」を優先。閾値は暫定 |

注記
- VBUS の 4.75-5.25 V は USB 2.0 の一般的な VBUS 許容範囲を根拠にした判定
- +3V3 の危険域閾値は PASS-A 用の暫定値であり、LDO 確定後に更新する

TP3（+3V3）危険域判定（PASS-A用・暫定）
- `+3V3` >= 3.8 V: 即停止（電源を抜く）
- 3.6 V <= `+3V3` < 3.8 V: 停止して原因調査（継続しない）
- `+3V3` < 0.2 V: FAIL（未供給 or 短絡疑い）
- 0.2 V <= `+3V3` < 2.7 V: FAIL（+3V3系として成立していない）
- 2.7 V <= `+3V3` < 3.0 V: FAIL（境界域。運用としては落とす）
- 3.0 V <= `+3V3` <= 3.6 V: PASS-A候補（安全域としてはOK）

合否基準（2段階）
- PASS-A（Safety Pass）: TP1/TP4 が 4.75-5.25 V かつ TP3 が「3.0-3.6 V」の暫定安全域にある
- PASS-B（Spec Pass）: 未確定/TODO。PASS-A を満たし、かつ確定済み +3V3 仕様レンジに入ること

PASS-B（Spec Pass）未確定理由
- LDO 型番が最終確定していない
- LDO の出力精度、温度特性、ライン/ロードレギュレーション条件が未確定
- 負荷条件（基板単体 / Pico + Tx/Rx 接続）ごとの仕様判定条件が未確定
- 既知の参考値として Tx/Rx の消費電流は `docs/parts.md` に Icc(max)=4.0mA と記載があるが、PASS-B 判定に必要な全体負荷条件は未確定

未確定事項リスト（PASS-B確定のためのTODO）
- +3V3 の PASS-B 期待レンジ未確定
  - 必要情報: 採用LDO最終型番、固定出力値、許容差、推奨コンデンサ条件
- PASS-B の温度条件未確定
  - 必要情報: 仕様レンジを定義する最低/最高温度と測定条件
- 負荷条件別の最大電流見積もり未確定（基板単体 / Pico+TxRx）
  - 必要情報: 搭載部品構成、Pico/Tx/Rxの動作モード別電流（起動直後・定常・ピーク）
- PASS-B 判定ルール未確定
  - 必要情報: 上記条件 + 計測器誤差（DMM精度）を反映した+3V3の最小/最大レンジと合否基準

NG 切り分け（TP1 → TP4 → TP3）
- TP1 が NG（VBUS_IN 不在/低すぎ/高すぎ）: ケーブル不良、USB ポート側制限、ハブ経由、J1 はんだ不良を疑う。ケーブル/ポートを変えて再測定し、変更内容を記録する
- TP1 が OK で TP4 が NG: F1（Polyfuse）周り（はんだ不良、部品不良、トレース断/短絡）を疑う。F1 前後ノードの導通と電圧差を確認する
- TP4 が OK で TP3 が NG: LDO（U1）周り（向き、はんだ、短絡、入出力コンデンサ）を疑う。U1 IN/OUT と GND 間の電圧を順に確認する
- TP3 が 3.6 V 以上の場合: 即停止または停止調査の条件に従い、原因が特定できるまで再通電しない
- ケーブル/USB ポート差は常に疑い候補として扱い、給電条件ログとひも付けて比較する

記録テンプレート（コピペして使用）
```md
- 日付(YYYY-MM-DD):
- 基板Rev（無いなら識別子）:
- 構成（ジャンパ/0Ω実装状態、Pico接続有無、TxRx接続有無）:
- 給電元（PC直結USB、ポート種別、ハブ有無）:
- ケーブル（種別A-C/A-A、長さ目測、識別メモ）:
- 計測器（DMM機種、レンジ=オート）:
- 環境（室温、20-30℃外ならその値）:
- 実測値（A: 基板単体）:
  - T+0-2s: TP1= , TP4=
  - T+10s: TP1= , TP4= , TP3=
  - T+60s(任意): TP1= , TP4= , TP3=
- 実測値（B: Pico+TxRx接続後）:
  - 起動10s: TP1= , TP4= , TP3=
  - 起動60s(任意): TP1= , TP4= , TP3=
- 判定（PASS-A / PASS-B / FAIL / STOP）:
- STOP時理由（該当時）:
- 写真リンク（配線と測定位置が分かるもの）:
```

---

## 3. Phase 2: MCU（Pico動作）
- [×] ThonnyでMicroPythonが実行できる（printが出る）
- [×] 使用GPIOが衝突していない（GP2/GP3/GP26など）

---

## 4. Phase 3: GPIO（電気の成立）
### 4.1 Tx（GP2）が出ていること
- [×] GP2を低速でトグル/PWMできる（最初は50Hz）

### 4.2 Rx（GP3）が読めること
- [×] GP3が入力として 0/1 を読み取れる

補足
- 受信が疑わしい場合は一度 Rx Vout を GP26(ADC) に繋いで、ON/OFFで電圧差が出るかを確認する（アナログ確認）。

---

## 5. Phase 4: Optical Link（電気→光→電気の成立）
### 5.1 FW（MicroPython / エッジカウント）
- GP2: PWM出力
- GP3: IRQ（RISING|FALLING）でエッジ数をカウント

期待値
- 50Hz → 100 edges/sec
- 100Hz → 200 edges/sec
- 200Hz → 400 edges/sec
- 400Hz → 800 edges/sec
- 500Hz → 1000 edges/sec

### 5.2 証拠（必須）
- ロジアナで GP2（Tx入力）と GP3（Rx出力）を同時観測し、スクショを残す
  - D0 = GP2
  - D1 = GP3

取得推奨
- OK例：100Hz（安定）
- OK例：200Hz（安定）
- 限界例：400Hz or 500Hz（マージン低下の例）


100Hz
![100Hz](./img/bringup/100hz.png)

200Hz
![200Hz](./img/bringup/200hz.png)

400Hz
![400Hz](./img/bringup/400hz.png)

500Hz
![500Hz](./img/bringup/500hz.png)
---

## 6. よくある失敗（NG集 / チェックリスト）
- 向き違い（Tx/Rx、ファイバ方向）
- GND共有が取れていない
- ブレッドボード接触不良（刺さりが浅い/同一列ミス）
- プルダウン抵抗で受信が潰れる（今回：220kΩでGP3が常時0になる）
- Tx側の配線不良（GP2→Tx Vin が外れている/刺さっていない）

---

## 付録A ブレッドボード暫定手順（将来廃止予定）
注意
- 本線は 2.3 PCB（USB→LDO→+3V3）電源Bring-up。これは暫定で、将来廃止予定。
- PCB手順のTP/判定と混同しないこと（必要なら別表）。

対象
- W2 相当のブレッドボード構成で、Pico 3V3(OUT) から Tx/Rx に給電する暫定確認のみ
- この付録の判定は 2.3 の PASS-A/PASS-B とは別管理

手順（暫定）
- Pico 3V3(OUT)（3.3Vレール）測定
- Tx VCC 測定
- Rx VCC 測定

測り方（暫定）
- 黒プローブ：Pico GND
- 赤プローブ：3.3Vレール（または Tx/Rx の VCC ピン）
