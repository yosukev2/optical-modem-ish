# LLM前提のKiCad開発運用（空ファイルで型を固定 → 差分で回路を作る）
このドキュメントは、KiCad設計をLLMと一緒に進めるための運用ルールを **1箇所に集約**したものです。  
目的は「壊れない」「差分が読める」「初心者でも手戻りが少ない」開発フローを作ることです。

---

## 1. 方針の結論（最重要）
- **0からの `.kicad_sch` 全文生成は不安定**  
  KiCadのバージョン差・ヘッダ構造・UUID・ライブラリ参照などで「開けない／壊れる」リスクが高い。
- **空ファイル（雛形）で型を固定した上で、LLMは追記（差分生成）に使う**  
  人がKiCadで作った“正しいフォーマット”を土台にすることで、LLMの成功率が上がる。

---

## 2. 役割分担
### 人がやる（必須）
- KiCadで **空プロジェクト**を作る
- `hw/step01_power.kicad_sch` など **空のStepファイル**を作る（雛形）
- KiCadで開いて **最終確認・微修正**する
- ERC/DRCの **最終判断**（PASS/FAIL、許容する警告の判断）

### LLMがやる（得意領域）
- 回路案の提案（構成、部品候補、注意点）
- チェックリスト（見落とし防止）
- **雛形を壊さない前提で**、追記後の `step01_power.kicad_sch` 全文を生成する
- PRレビュー（PDF/スクショ/ログを見て指摘・改善提案）

---

## 3. 最小運用フロー（Step単位）
### 3.1 初回のみ（型を固定する）
1. KiCadで `hw/` 配下に新規プロジェクト作成
2. `hw/step01_power.kicad_sch` を **空**で作成（雛形）
3. 雛形ができた状態をコミット

### 3.2 以降（LLMは差分で回路を作る）
1. LLMに入力する
   - 雛形（空の `step01_power.kicad_sch` の全文）
   - このドキュメントの運用ルール（最低：差分生成ルール＋命名規約）
   - 作りたい回路の要件（例：VBUS→+5V→+3V3、デカップリング等）
2. LLMに「追記後の `step01_power.kicad_sch` 全文」を出力させる
3. 人がKiCadで開く
   - ERCで確認
   - 見た目・配線・部品の妥当性を確認
   - 必要なら微修正
4. PR作成 → GitHubでマージ

---

## 4. “差分生成”のルール（壊さないための制約）
LLMに必ず守らせる制約：

- **既存ヘッダ / バージョン / 構造を変更しない**（必要最小限の追記のみ）
- **UUIDは既存を変更しない／重複させない**
- **座標や並びを無意味に変更しない**（差分ノイズ禁止）
- **ライブラリ参照は標準優先**（外部追加は別Issueで実施）

---

## 5.電源ネット命名規約（初版 v0.1）
目的：電源系のネット名を最初に固定し、回路図分割（Step01〜）でも混乱・誤配線・差分ノイズを減らす。  
原則：**電源ネット名はこの規約で“唯一の正”とし、別名を増やさない。**

### 1) 標準電源ネット（採用する名前）
本プロジェクトで使用する標準電源ネット名は以下：

- `VBUS_IN`：USB（または外部）から入ってくる生のVBUS。**保護/フィルタ前**の入力点。
- `+5V`：5Vレール。**保護・スイッチ・ヒューズ・フィルタ後**の「使ってよい5V」。
- `+3V3`：3.3Vレール。LDO/レギュレータ出力の主電源。
- `GND`：グランド（0V基準）。基本は単一 `GND` に統一。

> 重要：`5V`（プラスなし）や `3V3`（プラスなし）等の近い名前を混在させない。  
> 常に `+5V` / `+3V3` を使う。

### 2) 命名の適用ルール（いつ使うか）
- USBコネクタ直後のVBUSは `VBUS_IN`
  - 例：コネクタVBUS → ESD/ヒューズ/スイッチ前 = `VBUS_IN`
- 5Vを「回路で利用するレール」として配る点以降は `+5V`
  - 例：ヒューズ後、電源スイッチ後、フィルタ後 = `+5V`
- LDO/レギュレータの出力は `+3V3`
  - 例：レギュレータOUT → デカップリング → 配電 = `+3V3`
- グランドは常に `GND`  
  - アナログ/デジタル分離を最初からしない（必要になったら別Issueで導入）。

### 3) 分岐・派生名のルール（増やす条件を明確化）
原則：**派生名（例：+5V_USB, +3V3_AUX）を増やさない。**  
例外：以下のいずれかが必要になった時のみ、別Issueで導入する。

- 電源系統が物理的に別（別レギュレータ/別バッテリ/別電源入力）
- 電源シーケンス・スイッチ制御でレールを明確に分ける必要がある
- 測定やノイズ対策で明確に別レールとして扱う設計判断がある

導入時の派生名規則（採用する場合）：
- 形式：`+5V_<用途>` / `+3V3_<用途>`（用途は小文字スネーク推奨）
- 例：`+5V_usb`、`+3V3_rf`（※導入は必ず別Issue＋理由明記）

### 4) デカップリングと電源シンボルの扱い
- デカップリングの電源ピンは、必ず上記の標準ネット名に接続する
- 可能なら「電源シンボル（Power Symbol）」も標準名に合わせる
- LLMに回路を追記させる場合も、**電源ピンが標準名になっているか**を最優先で確認する

### 5) レビュー観点（最小チェックリスト）
PRレビュー（人/LLM共通）で必ず確認する：
- [ ] `VBUS_IN` / `+5V` / `+3V3` / `GND` 以外の近い電源名が増えていない
- [ ] `VBUS_IN` と `+5V` の境界が「保護/フィルタ/スイッチ後」になっている
- [ ] レギュレータ出力が `+3V3` に統一されている
- [ ] `GND` が分裂していない（意図がある場合は別Issue）

### 6) 変更ルール（この規約の更新）
- 新しい電源レール名を追加したい場合は、必ずIssueを作る
- 追加時に記録すること：
  - 追加理由（なぜ分ける必要があるか）
  - 追加するネット名
  - どこからどこまでがそのレールか（境界の定義）

---

## 6. PRレビューの“証跡”要件（LLMレビューを強くする）
PRには最低限、以下を添付する（LLMレビューもここを見る）：
- 変更したStepの **回路図PDF**（またはスクショ）
- **ERC結果**（スクショ/ログ）
- What/Why（短文でOK）

---

## 7. 例外・注意（初心者向け）
- `.kicad_pcb` は衝突しやすいので **同時編集を避ける**  
  原則：担当者固定 or 順番制
- コンフリクト発生時は **テキストで無理に直さない**  
  KiCadで開いて修正し、ERC/DRCで再確認して解決する

---

## 8. Done（受け入れ条件 / Acceptance Criteria）
この `docs/kicad_llm_workflow.md` に以下が明記されていること：

- **「0からは不安定」「空ファイルで型固定→差分生成が現実解」**の結論
- 人/LLMの役割分担
- 初回セットアップ（空プロジェクト・空stepファイル作成→コミット）
- 差分生成の制約（壊さないルール）
- 電源ネット命名規約（`VBUS_IN / +5V / +3V3 / GND`）
- PRに添付する証跡（PDF/ERC/要約）
- 初心者が読んで、同じ手順で運用を開始できる程度に簡潔である

---

## 9. Scope（範囲）
- 運用ドキュメント（MD）の作成のみ

---

## 10. Notes（メモ）
- LLMは「文章・チェック・レビュー」に強い一方、「KiCadの内部形式を0から完璧に再現」は不安定。
- 雛形（空sch）をKiCadで作って“型”を確定させることで、LLMは壊しにくくなり成功率が上がる。
- 証跡（PDF/ERC）をPRに添付すると、人もLLMもレビュー精度が上がる。
