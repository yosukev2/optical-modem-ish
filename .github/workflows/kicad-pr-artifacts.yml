name: KiCad PR artifacts (pdf/erc/drc)

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    paths:
      - "hw/**"
      - ".github/workflows/kicad-pr-artifacts.yml"

concurrency:
  group: kicad-pr-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  kicad:
    runs-on: ubuntu-latest
    container:
      image: kicad/kicad:9.0.7
      options: --user root

    defaults:
      run:
        shell: bash
        working-directory: ${{ github.workspace }}

    steps:
      - name: Install deps
        run: |
          set -euo pipefail
          apt-get update
          apt-get install -y git ca-certificates poppler-utils
          git --version
          kicad-cli version

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          submodules: recursive

      - name: Mark workspace as safe for git
        run: |
          set -euo pipefail
          git config --global --add safe.directory "$GITHUB_WORKSPACE"
          git config --global --add safe.directory "$(pwd)"

      - name: Export PDF + run ERC (all schematics)
        run: |
          set -euo pipefail
          OUT_DIR="hw/out"
          mkdir -p "$OUT_DIR"

          {
            echo "runner=$(uname -a)"
            echo "kicad_cli=$(kicad-cli version 2>/dev/null || true)"
            echo "pr=${{ github.event.pull_request.number }}"
            echo "base_sha=${{ github.event.pull_request.base.sha }}"
            echo "head_sha=${{ github.event.pull_request.head.sha }}"
          } > "$OUT_DIR/meta.txt"

          SCH_FILES="$(find hw -type f -name '*.kicad_sch' | sort || true)"
          if [ -z "$SCH_FILES" ]; then
            echo "No schematics found under hw/"
            exit 0
          fi

          while IFS= read -r SCH; do
            [ -n "$SCH" ] || continue
            NAME="$(basename "$SCH" .kicad_sch)"

            kicad-cli sch export pdf --output "$OUT_DIR/${NAME}.pdf" "$SCH"
            pdftoppm -png -f 1 -singlefile "$OUT_DIR/${NAME}.pdf" "$OUT_DIR/${NAME}"

            # 1) report everything (do not fail)
            kicad-cli sch erc \
              --format json \
              --severity-all \
              --output "$OUT_DIR/${NAME}_erc_all.json" \
              "$SCH" || true

            # 2) gate on errors only (fail if errors exist)
            kicad-cli sch erc \
              --format json \
              --severity-error \
              --exit-code-violations \
              --output "$OUT_DIR/${NAME}_erc_error.json" \
              "$SCH"
          done <<< "$SCH_FILES"

      - name: Run DRC (if any .kicad_pcb exists) [non-blocking]
        continue-on-error: true
        run: |
          set -euo pipefail
          OUT_DIR="hw/out"
          mkdir -p "$OUT_DIR"

          PCB_FILES="$(find hw -type f -name '*.kicad_pcb' | sort || true)"
          if [ -z "$PCB_FILES" ]; then
            exit 0
          fi

          while IFS= read -r PCB; do
            [ -n "$PCB" ] || continue
            NAME="$(basename "$PCB" .kicad_pcb)"

            kicad-cli pcb drc \
              --format json \
              --severity-all \
              --exit-code-violations \
              --output "$OUT_DIR/${NAME}_drc.json" \
              "$PCB" || true
          done <<< "$PCB_FILES"

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: kicad-pr-${{ github.event.pull_request.number }}
          path: hw/out/**
          if-no-files-found: warn
          retention-days: 14
